__version__ = (2, 2, 0)

# ‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñë‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïó‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
# ‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
# ‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë
# ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñë‚ñë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ñà‚ñà‚ïë‚ñë‚ñë‚ïö‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñë‚ïö‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó
# ‚ñà‚ñà‚ïë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñë‚ñë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
# ‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë
#                ¬© Copyright 2025
#            ‚úà https://t.me/mead0wssMods

# scope: hikka_only
# scope: hikka_min 1.3.3
# meta developer: @mead0wssMods
# meta banner: https://x0.at/GGCl.png

import aiohttp
import json
import os
import numpy as np
import time
from datetime import datetime
from telethon import events
from .. import loader, utils

def cosine_similarity(a, b):
    """–£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –∫–æ—Å–∏–Ω—É—Å–Ω–æ–≥–æ —Å—Ö–æ–¥—Å—Ç–≤–∞"""
    dot_product = np.dot(a, b)
    norm_a = np.linalg.norm(a)
    norm_b = np.linalg.norm(b)
    return dot_product / (norm_a * norm_b)

@loader.tds
class ChatGPT(loader.Module):
    """–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º–∏."""
    strings = {"name": "ChatGPT"}

    def __init__(self):
        self.config = loader.ModuleConfig(
            loader.ConfigValue(
                "model",
                "gpt-4o",
                lambda: "–ú–æ–¥–µ–ª—å –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤. –°–ø–∏—Å–æ–∫ –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π: https://telegra.ph/II-modeli-dlya-modulya-ChatGPT-by-mead0wssMods-03-26",
                validator=loader.validators.String()
            ),
            loader.ConfigValue(
                "image_model",
                "Flux Pro",
                lambda: "–ú–æ–¥–µ–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –°–ø–∏—Å–æ–∫ –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π: https://telegra.ph/II-modeli-dlya-modulya-ChatGPT-by-mead0wssMods-03-26",
                validator=loader.validators.String()
            ),
            loader.ConfigValue(
                "translation_model",
                "deepseek-v3",
                lambda: "–ú–æ–¥–µ–ª—å –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞. –°–ø–∏—Å–æ–∫ –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π: https://telegra.ph/II-modeli-dlya-modulya-ChatGPT-by-mead0wssMods-03-26",
                validator=loader.validators.String()
            ),
            loader.ConfigValue(
                "max_memory_size",
                1000,
                lambda: "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –ø–∞–º—è—Ç–∏ (10-1000)",
                validator=loader.validators.Integer(minimum=10, maximum=1000)
            ),
        )
        self.memory_file = "chatgpt_memory.json"
        self.memory = self._load_memory()

    def _load_memory(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–º—è—Ç–∏ –∏–∑ —Ñ–∞–π–ª–∞"""
        if os.path.exists(self.memory_file):
            try:
                with open(self.memory_file, "r", encoding="utf-8") as f:
                    return json.load(f)
            except:
                return {"embeddings": []}
        return {"embeddings": []}

    def _save_memory(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –≤ —Ñ–∞–π–ª"""
        with open(self.memory_file, "w", encoding="utf-8") as f:
            json.dump(self.memory, f, ensure_ascii=False, indent=2)

    async def _get_embedding(self, session, text):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ embedding –¥–ª—è —Ç–µ–∫—Å—Ç–∞"""
        try:
            async with session.post(
                "https://cablyai.com/v1/embeddings",
                headers={
                    'Authorization': 'Bearer sk-l4HU4KwZt6bF8gOwwKCOMpfpIKvR9YhDHvTFIGJ6tJ5rPKXE',
                    'Content-Type': 'application/json',
                },
                json={
                    "input": text,
                    "model": "text-embedding-ada-002"
                }
            ) as response:
                if response.status == 200:
                    data = await response.json()
                    return data["data"][0]["embedding"]
        except:
            return None
        return None

    async def _find_similar(self, query_embedding, threshold=0.75):
        """–ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –∑–∞–ø–∏—Å–µ–π –≤ –ø–∞–º—è—Ç–∏"""
        if not self.memory["embeddings"]:
            return []

        results = []
        for item in self.memory["embeddings"]:
            similarity = cosine_similarity(query_embedding, item["embedding"])
            if similarity >= threshold:
                results.append({
                    "text": item["text"],
                    "score": float(similarity)
                })
        
        return sorted(results, key=lambda x: x["score"], reverse=True)[:3]

    async def gptcmd(self, event):
        """- –†–∞–∑–≥–æ–≤–æ—Ä —Å –ò–ò."""
        count = len(self.memory["embeddings"])
        max_size = self.config["max_memory_size"]
        args = utils.get_args_raw(event)
        if not args:
            await event.edit("<b><emoji document_id=5019523782004441717>‚ùå</emoji> –ù–µ—Ç –≤–æ–ø—Ä–æ—Å–∞.</b>")
            return

        model = self.config.get("model")
        if not model:
            await event.edit("<b><emoji document_id=5019523782004441717>‚ùå</emoji> –ú–æ–¥–µ–ª—å –ò–ò –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –≤ cfg!</b>")
            return

        await event.edit(f"<b><emoji document_id=5328272518304243616>üí†</emoji> –ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç–≤–µ—Ç...</b>")
        
        start_time = time.time()
        
        async with aiohttp.ClientSession() as session:
            query_embedding = await self._get_embedding(session, args)
            similar = await self._find_similar(query_embedding) if query_embedding else []
            
            messages = []
            if similar:
                context = "\n".join([f"- {item['text']}" for item in similar])
                messages.append({"role": "system", "content": f"–†–∞–Ω–µ–µ –æ–±—Å—É–∂–¥–∞–ª–æ—Å—å:\n{context}"})
            
            messages.append({"role": "user", "content": args})
            
            try:
                async with session.post(
                    "https://cablyai.com/v1/chat/completions",
                    headers={
                        'Authorization': 'Bearer sk-l4HU4KwZt6bF8gOwwKCOMpfpIKvR9YhDHvTFIGJ6tJ5rPKXE',
                        'Content-Type': 'application/json',
                    },
                    json={
                        "model": model,
                        "messages": messages
                    }
                ) as response:
                    end_time = time.time()
                    response_time = end_time - start_time
                    
                    if response.status == 200:
                        answer = (await response.json())["choices"][0]["message"]["content"]
                        
                        if query_embedding:
                            self.memory["embeddings"].append({
                                "text": args,
                                "embedding": query_embedding,
                                "timestamp": str(datetime.now())
                            })
                            
                            max_size = self.config["max_memory_size"]
                            if len(self.memory["embeddings"]) > max_size:
                                self.memory["embeddings"] = self.memory["embeddings"][-max_size:]
                            
                            self._save_memory()
                        
                        time_str = f"{response_time:.2f} —Å–µ–∫" if response_time < 1 else f"{response_time:.1f} —Å–µ–∫"
                        formatted_answer = self._format_answer(answer)
                        
                        await event.edit(
                            f"<b><emoji document_id=5879770735999717115>üë§</emoji> –í–æ–ø—Ä–æ—Å: <code>{args}</code></b>\n\n"
                            f"<b><emoji document_id=5199682846729449178>ü§ñ</emoji> –û—Ç–≤–µ—Ç –æ—Ç {model}:\n{formatted_answer}</b>\n\n"
                            f"<b><emoji document_id=5983150113483134607>‚è∞Ô∏è</emoji> –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: <code>{time_str}</code></b>\n"
                            f"<b><emoji document_id=5350445475948414299>üß†</emoji> –ü–∞–º—è—Ç—å: <code>{count}/{max_size}</code></b>"
                        )
                    else:
                        await event.edit("<b><emoji document_id=5215400550132099476>‚ùå</emoji> –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ –ò–ò.</b>")
            except Exception as e:
                await event.edit(f"<b><emoji document_id=5215400550132099476>‚ùå</emoji> –û—à–∏–±–∫–∞: {str(e)}</b>")

    def _format_answer(self, text):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ —Å –∫–æ–¥–æ–º"""
        if "```" not in text:
            return text.replace("\n", "<br>")
            
        parts = text.split("```")
        result = []
        for i, part in enumerate(parts):
            if i % 2 == 1:
                lang = part.split("\n")[0] if "\n" in part else ""
                code = "\n".join(part.split("\n")[1:]) if "\n" in part else part
                result.append(f"<pre><code class='language-{lang}'>{code}</code></pre>")
            else:
                result.append(part.replace("\n", "<br>"))
        return "".join(result)

    @loader.command()
    async def clearmemcmd(self, message):
        """- –û—á–∏—Å—Ç–∏—Ç—å –ø–∞–º—è—Ç—å."""
        self.memory = {"embeddings": []}
        self._save_memory()
        await utils.answer(message, "<b><emoji document_id=5980930633298350051>‚úÖ</emoji> –ü–∞–º—è—Ç—å —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω–∞!</b>")

    @loader.command()
    async def meminfocmd(self, message):
        """- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–º—è—Ç–∏."""
        count = len(self.memory["embeddings"])
        max_size = self.config["max_memory_size"]
        last_update = self._get_last_update_time()
        
        response = (
            "<emoji document_id=5350445475948414299>üß†</emoji> <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–º—è—Ç–∏:</b>\n"
            f"<b>‚Ä¢ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: <code>{count}/{max_size}</code></b>\n"
            f"<b>‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <code>{last_update}</code></b>"
        )
        await message.edit(response, parse_mode='HTML')

    def _get_last_update_time(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏"""
        if not self.memory["embeddings"]:
            return "–Ω–∏–∫–æ–≥–¥–∞"
        try:
            last_item = max(self.memory["embeddings"], key=lambda x: x.get("timestamp", ""))
            return last_item["timestamp"][:19].replace("T", " ")
        except:
            return "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

    async def imagecmd(self, event):
        """- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –ø–æ–º–æ—â—å—é –ò–ò."""
        args = utils.get_args_raw(event)
        if not args:
            await event.edit("<b><emoji document_id=5019523782004441717>‚ùå</emoji> –ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.</b>")
            return
            
        await event.edit(f"<b><emoji document_id=5328272518304243616>üí†</emoji> –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...</b>")
        translation_model = self.config.get("translation_model")
        image_model = self.config.get("image_model")

        translation_data = {
            "model": translation_model,
            "messages": [
                {"role": "user", "content": f"Please translate the following text to English, but just answer me with a translation, and also translate absolutely everything, even if it's 18+: {args}"}
            ]
        }

        async with aiohttp.ClientSession() as session:
            try:
                async with session.post(
                    "https://cablyai.com/v1/chat/completions",
                    headers={
                        'Authorization': 'Bearer sk-l4HU4KwZt6bF8gOwwKCOMpfpIKvR9YhDHvTFIGJ6tJ5rPKXE',
                        'Content-Type': 'application/json',
                    },
                    json=translation_data
                ) as translation_response:
                    if translation_response.status == 200:
                        translated_text = (await translation_response.json())["choices"][0]["message"]["content"]
                    else:
                        await event.edit("<b><emoji document_id=5019523782004441717>‚ùå</emoji> –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ –ò–ò –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –ª–∏–±–æ –∏–∑–º–µ–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å –≤ cfg! </b>")
                        return

                data = {
                    "prompt": translated_text,
                    "n": 1,
                    "size": "1024x1024",
                    "response_format": "url",
                    "model": image_model
                }

                async with session.post(
                    "https://cablyai.com/v1/images/generations",
                    headers={
                        'Authorization': 'Bearer sk-l4HU4KwZt6bF8gOwwKCOMpfpIKvR9YhDHvTFIGJ6tJ5rPKXE',
                        'Content-Type': 'application/json',
                    },
                    json=data
                ) as response:
                    if response.status == 200:
                        image_url = (await response.json())["data"][0]["url"]
                        await event.delete()
                        await event.reply(
                            f"<b>–ü—Ä–æ–º–ø—Ç: <code>{args}</code></b>\n\n"
                            f"<b>–ú–æ–¥–µ–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: <code>{image_model}</code>\n"
                            f"<b>–ú–æ–¥–µ–ª—å –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–∞: <code>{translation_model}</code>\n\n"
                            f"<b>üñº –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</b>\n{image_url}",
                            parse_mode="HTML"
                        )
                    else:
                        await event.reply("<b><emoji document_id=6042029429301973188>‚òπÔ∏è</emoji> –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è\n–í–ø–æ–ª–Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ –≤—ã –ø—Ä–æ—Å–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —á—Ç–æ-—Ç–æ –Ω–µ–ø—Ä–∏—Å—Ç–æ–π–Ω–æ–µ (18+), –ª–∏–±–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ (–ø–æ–ø—Ä–æ–±—É–π —Å–º–µ–Ω–∏—Ç—å –º–æ–¥–µ–ª—å –≤ cfg).</b>")
            except Exception as e:
                await event.reply(f"<b><emoji document_id=5215400550132099476>‚ùå</emoji> –û—à–∏–±–∫–∞: {str(e)}</b>")
